module.exports=function(h){var p=require("path"),q=require("fs"),g=h.file.readJSON("config.json"),n=function(a){this.fs=q;this.path=p;var c=(__dirname+"/").replace(/\\/g,"/");this.rootpath=c+(a.root||"");this.needDir=this.rootpath+(a.src||"");this.regExp=new RegExp(a.needRegExp||"");this.voidRegExp=a.voidRegExp?new RegExp(a.voidRegExp):null;this.files={};this.defined={};this.destpath=c+a.dest;this.rootpathReg=new RegExp("^"+this.rootpath);this.concatFiles={};this.staticFiles={};this.paths=a.paths||
{};this.baseUrl=a.baseUrl||"";this.min=a.min||!1;this.less=a.less||!1;this.lessFiles={};this.lessRegExp=new RegExp(a.lessRegExp||"");this.lessDir=this.rootpath+(a.lessSrc||"")};n.prototype={readdir:function(a){if(this.fs.existsSync(a)){var c=this.fs.readdirSync(a),d;for(d in c){var b=a.match(/\/$/)?a+c[d]:a+"/"+c[d],e=this.fs.statSync(b);if(e.isFile()&&b.match(this.regExp)&&(!this.voidRegExp||!b.match(this.voidRegExp))){var g=b.replace(this.rootpathReg,"");this.files[g]=this.fs.readFileSync(b,{encoding:"utf8"})}e.isDirectory()&&
this.readdir(b)}}},"do":function(){this.readdir(this.needDir);this.compile()},compile:function(){for(var a in this.files){var c=this.destpath+a,d=this.path.dirname(c);this.fs.existsSync(d)||this.mkdir(d,511);var d=this.files[a].match(/require\s*\(\s*\[[^\])]*\]/g),b;for(b in d){var e=d[b].replace(/require\s*\(\s*\[|[\'\"\s\]]/g,"").split(",");this.analyzeConcat(c,e)}this.concatFiles[c].push(this.rootpath+a)}},analyzeConcat:function(a,c){if(""!=a){"undefined"==typeof this.concatFiles[a]&&(this.concatFiles[a]=
[]);for(var d in c){var b="",b="undefined"!=typeof this.paths[c[d]]?b+(this.rootpath+this.baseUrl+this.paths[c[d]]):b+(this.rootpath+this.baseUrl+c[d]);this.fs.existsSync(b+".js")?b+=".js":this.fs.existsSync(b+"/index.js")&&(b+="/index.js");this.fs.existsSync(b)&&-1==this.concatFiles[a].toString().indexOf(b)&&(this.concatFiles[a].push(b),b=this.staticFile(b),0<b.length&&this.analyzeConcat(a,b))}}},staticFile:function(a,c){if(this.fs.existsSync(a)&&"undefined"==typeof this.staticFiles[a]){this.staticFiles[a]=
[];var d=this.fs.readFileSync(a,{encoding:"utf8"}).match(/define\s*\(\s*\[[^\])]*\]/g),b;for(b in d){var e=d[b].replace(/define\s*\(\s*\[|[\'\"\s\]]/g,"").split(","),g=this.staticFiles[a],k=void 0;for(k in e)g.push(e[k])}}return this.staticFiles[a]},mkdir:function(a,c){var d=this.path.dirname(a);this.fs.existsSync(a)||this.mkdir(d,c);this.fs.existsSync(a)||this.fs.mkdirSync(a,c)},getConcatFiles:function(){if(this.min){var a={},c;for(c in this.concatFiles)a[c.replace(/\.js$/g,".min.js")]=this.concatFiles[c];
return a}return this.concatFiles},readdirLess:function(a){var c=this.fs.readdirSync(a),d;for(d in c){var b=a.match(/\/$/)?a+c[d]:a+"/"+c[d],e=this.fs.statSync(b);e.isFile()&&b.match(this.lessDir)&&(this.lessFiles[b.replace(this.rootpathReg,this.destpath).replace(".less",".css")]=b);e.isDirectory()&&this.readdirLess(b)}},getLessFiles:function(){this.less&&this.readdirLess(this.lessDir);return this.lessFiles}};var l=new n(g);l["do"]();var n=l.getConcatFiles(),l=l.getLessFiles(),m=[];h.initConfig({concat:{options:{separator:"",
process:function(a,c){var d=a,b=p.basename(c,".js");if(g.paths&&"undefined"==typeof g.paths[b])var e=new RegExp((__dirname+"/"+g.root+g.baseUrl).replace(/\\/g,"/")+"|.js","g"),b=c.replace(e,"");var h=d.match(/__template__\s*\([^\)]*\)/g),k;for(k in h)if("undefined"==typeof m[k]){var f=h[k].replace(/__template__\s*\(\s*[\'\"]?|[\'\"]\)$/g,""),e=new RegExp(h[k].replace(/\(/g,"\\(").replace(/\)/g,"\\)"),"g"),f=p.join(__dirname,g.root,f);"undefined"==typeof m[f]&&q.existsSync(f)&&(m[f]=q.readFileSync(f,
{encoding:"utf8"}));if("undefined"!=typeof m[f])var l=h[k].replace(/\)/g,""),f=m[f].replace(/\'/g,"\\'"),f=f.replace(/[\n\r]/g,""),f=l+",'"+f+"')",d=d.replace(e,f)}return d.replace(/define\s*\(\s*\[/g,'define("'+b+'",[')}},bar:{files:n}},uglify:{options:{banner:'/*! <%= grunt.template.today("yyyy-mm-dd") %> */\n'},build:{files:[{expand:!0,cwd:g.dest,src:"**/*.js",dest:g.dest}]}},less:{development:{options:{compress:!0,ieCompat:!0,relativeUrls:!1,customFunctions:{}},files:l}}});h.loadNpmTasks("grunt-contrib-concat");
h.loadNpmTasks("grunt-contrib-uglify");h.loadNpmTasks("grunt-contrib-less");h.registerTask("default",["concat","uglify","less"])};